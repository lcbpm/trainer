# 8. 性能优化

## 目录
- [8.1 代码优化](#81-代码优化)
- [8.2 JVM 性能调优](#82-jvm-性能调优)

---

## 8.1 代码优化

```java
// 字符串拼接优化
// 不推荐
String result = "";
for (String s : list) {
    result += s;  // 每次都创建新的String对象
}

// 推荐
StringBuilder sb = new StringBuilder();
for (String s : list) {
    sb.append(s);
}
String result = sb.toString();

// 集合初始化优化
List<String> list = new ArrayList<>(expectedSize);
Map<String, String> map = new HashMap<>(expectedSize);

// 避免装箱拆箱
// 不推荐
Integer count = 0;
for (int i = 0; i < 1000000; i++) {
    count += i;  // 频繁装箱拆箱
}

// 推荐
int count = 0;
for (int i = 0; i < 1000000; i++) {
    count += i;
}
```

## 8.2 JVM 性能调优

```java
// JVM性能监控工具使用
public class PerformanceMonitor {
    
    // 监控内存使用
    public void printMemoryInfo() {
        MemoryMXBean memoryMX = ManagementFactory.getMemoryMXBean();
        MemoryUsage heapUsage = memoryMX.getHeapMemoryUsage();
        
        System.out.println("堆内存使用情况:");
        System.out.println("已使用: " + heapUsage.getUsed() / 1024 / 1024 + "MB");
        System.out.println("最大值: " + heapUsage.getMax() / 1024 / 1024 + "MB");
    }
    
    // 监控GC情况
    public void printGCInfo() {
        List<GarbageCollectorMXBean> gcBeans = ManagementFactory.getGarbageCollectorMXBeans();
        for (GarbageCollectorMXBean gcBean : gcBeans) {
            System.out.println("GC名称: " + gcBean.getName());
            System.out.println("GC次数: " + gcBean.getCollectionCount());
            System.out.println("GC时间: " + gcBean.getCollectionTime() + "ms");
        }
    }
}

## 系统流量评估与性能指标

### 基础性能计算
- **单核处理能力**：1个请求耗时20ms → 1秒处理50个请求
- **多核处理能力**：8核16线程 → 16 × 50 = 800请求/秒
- **实际可用性能**：800 × 70% = 560请求/秒（考虑系统开销）

### 目标QPS范围
- **最低目标**：30,000 QPS
- **最高目标**：60,000 QPS

### 扩展性需求分析
- **3万QPS所需实例数**：30,000 ÷ 560 ≈ 54台
- **6万QPS所需实例数**：60,000 ÷ 560 ≈ 108台

### 性能优化建议
1. **水平扩展**：根据计算结果部署54-108台服务器实例
2. **负载均衡**：使用负载均衡器分发请求
3. **性能监控**：实时监控各实例的CPU、内存使用率
4. **自动伸缩**：基于监控指标实现自动扩缩容