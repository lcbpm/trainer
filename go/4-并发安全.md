# 4. å¹¶å‘å®‰å…¨

### ğŸ”‘ Go `sync.Mutex` çš„å®ç°åŸç†

Go çš„ `sync.Mutex` æœ¬è´¨æ˜¯ä¸€ä¸ªåŸºäº **CAS + è‡ªæ—‹ + ä¿¡å·é‡** çš„æ··åˆé”ï¼Œæ ¸å¿ƒç›®æ ‡æ˜¯ **å‡å°‘ç³»ç»Ÿè°ƒç”¨**ã€**æé«˜å¹¶å‘æ€§èƒ½**ã€‚

#### å†…éƒ¨ç»“æ„

åœ¨ Go æºç é‡Œï¼ˆ`runtime2.go`ï¼‰ï¼Œ`Mutex` å¤§è‡´å®šä¹‰å¦‚ä¸‹ï¼š

```go
type Mutex struct {
    state int32  // é”çš„çŠ¶æ€
    sema  uint32 // ä¿¡å·é‡ï¼Œç”¨äºæŒ‚èµ·/å”¤é†’
}
```

#### state çš„å«ä¹‰

* `0`ï¼šæœªåŠ é”
* `1`ï¼šåŠ é”ï¼ˆæ— å…¶ä»–ç­‰å¾…è€…ï¼‰
* `>1`ï¼šåŠ é” + ç­‰å¾…é˜Ÿåˆ—å­˜åœ¨

#### åŠ é”è¿‡ç¨‹ (`Lock`)

1. **CAS å°è¯•åŠ é”**ï¼šç”¨ `CAS` å°† `state` ä» `0` æ”¹ä¸º `1`ï¼ŒæˆåŠŸåˆ™ç›´æ¥è·å¾—é”ã€‚
2. **è‡ªæ—‹ç­‰å¾…**ï¼šå¦‚æœå¤±è´¥ï¼Œå°è¯•åœ¨å¤šæ ¸ CPU ä¸Š **çŸ­æš‚è‡ªæ—‹**ï¼ˆç©ºè½¬å‡ æ¬¡ï¼Œå¯èƒ½é”å¾ˆå¿«é‡Šæ”¾ï¼‰ã€‚
3. **æŒ‚èµ·ç­‰å¾…**ï¼šå¦‚æœè‡ªæ—‹åè¿˜æ˜¯æ²¡æŠ¢åˆ°ï¼Œåˆ™æŠŠè‡ªå·±æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œå¹¶è°ƒç”¨ `semacquire` è®© goroutine è¿›å…¥ä¼‘çœ ï¼ˆé¿å…æµªè´¹ CPUï¼‰ã€‚
4. **è¢«å”¤é†’**ï¼šå½“æŒæœ‰é”çš„ goroutine è°ƒç”¨ `Unlock` æ—¶ï¼Œä¼šé€šè¿‡ `semrelease` å”¤é†’ç­‰å¾…é˜Ÿåˆ—é‡Œçš„ä¸€ä¸ª goroutineã€‚

#### è§£é”è¿‡ç¨‹ (`Unlock`)

1. **CAS é‡Šæ”¾é”**ï¼šå°† `state` è®¾ä¸º 0ã€‚
2. **å”¤é†’ç­‰å¾…è€…**ï¼šå¦‚æœ `state` > 1ï¼Œè¯´æ˜æœ‰ç­‰å¾…è€…ï¼Œä¼šè°ƒç”¨ `semrelease` å”¤é†’ä¸€ä¸ª goroutineã€‚

---

### ğŸ”‘ Go `sync.RWMutex` çš„å®ç°åŸç†

`RWMutex` æ˜¯è¯»å†™åˆ†ç¦»çš„é”ï¼Œå…è®¸å¤šä¸ªè¯»è€…å¹¶å‘è®¿é—®ï¼Œä½†å†™è€…ç‹¬å ã€‚

#### å†…éƒ¨ç»“æ„ï¼ˆç®€åŒ–ç‰ˆï¼‰

```go
type RWMutex struct {
    w           Mutex  // å†™é”ï¼Œä¿è¯å†™æ“ä½œäº’æ–¥
    writerSem   uint32 // å†™ç­‰å¾…è€…çš„ä¿¡å·é‡
    readerSem   uint32 // è¯»ç­‰å¾…è€…çš„ä¿¡å·é‡
    readerCount int32  // å½“å‰æ­£åœ¨æŒæœ‰è¯»é”çš„ goroutine æ•°é‡
    readerWait  int32  // ç­‰å¾…å†™é”çš„ goroutine éœ€è¦ç­‰å¾…çš„è¯»é”æ•°é‡
}
```

#### è¯»é” (`RLock`)

1. `readerCount++`ï¼šå¦‚æœç»“æœ â‰¥0ï¼Œè¯´æ˜æ²¡æœ‰å†™é”ï¼Œç›´æ¥è·å–è¯»é”ã€‚
2. å¦‚æœ `readerCount < 0`ï¼Œè¯´æ˜æœ‰å†™è€…åœ¨ç­‰å¾…ï¼Œåˆ™å½“å‰è¯»è€…éœ€è¦é˜»å¡åœ¨ `readerSem` ä¸Šã€‚

#### å†™é” (`Lock`)

1. å…ˆé€šè¿‡ `w.Lock()` æŠ¢åˆ°äº’æ–¥é”ï¼Œä¿è¯åªæœ‰ä¸€ä¸ªå†™è€…è¿›å…¥ä¸´ç•ŒåŒºã€‚
2. å°† `readerCount` å‡å»ä¸€ä¸ªå¾ˆå¤§çš„æ•°ï¼ˆé€šå¸¸æ˜¯ `-rwmutexMaxReaders`ï¼‰ï¼Œæ ‡è®°å†™é”ç­‰å¾…ä¸­ã€‚
3. å¦‚æœæ­¤æ—¶ `readerCount != 0`ï¼Œè¯´æ˜è¿˜æœ‰è¯»è€…æŒæœ‰é”ï¼Œå†™è€…ä¼šé˜»å¡åœ¨ `writerSem` ä¸Šï¼Œç›´åˆ°è¯»è€…é‡Šæ”¾ã€‚

#### è§£é”

* `RUnlock`ï¼š`readerCount--`ï¼Œå¦‚æœæœ€åä¸€ä¸ªè¯»è€…é‡Šæ”¾æ—¶å‘ç°æœ‰å†™è€…åœ¨ç­‰ï¼Œå°±å”¤é†’å†™è€…ã€‚
* `Unlock`ï¼šé‡Šæ”¾å†™é”åï¼Œæ¢å¤ `readerCount`ï¼Œå¹¶å”¤é†’æ‰€æœ‰è¢«é˜»å¡çš„è¯»è€…ã€‚

---

### ğŸ”‘ å…¬å¹³æ€§å’Œæ€§èƒ½æƒè¡¡

* **Mutex**

  * Go çš„ `sync.Mutex` å¹¶ä¸æ˜¯ä¸¥æ ¼å…¬å¹³é”ï¼ˆä¸æ˜¯ FIFO é˜Ÿåˆ—ï¼‰ã€‚
  * å®ƒåœ¨çŸ­æš‚è‡ªæ—‹æ—¶ï¼Œå¯èƒ½è®©åæ¥çš„ goroutine æŠ¢åˆ°é” â†’ **ç‰ºç‰²å…¬å¹³æ€§æ¢å–æ€§èƒ½**ã€‚
* **RWMutex**

  * é»˜è®¤æ˜¯ **å†™è€…ä¼˜å…ˆ**ï¼Œé¿å…å†™è€…é•¿æœŸé¥¥é¥¿ã€‚
  * å†™è€…æ¥äº†ä¼šé˜»å¡åç»­è¯»è€…ï¼ˆ`readerCount < 0` çš„æœºåˆ¶ï¼‰ã€‚

---

### ğŸ”‘ å†…å­˜å±éšœçš„ä½œç”¨

* Go åœ¨ `atomic` å’Œ `lock/unlock` æ“ä½œä¸­ï¼Œä¼šæ’å…¥ **å†…å­˜å±éšœï¼ˆmemory fenceï¼‰**ï¼Œä¿è¯å¯è§æ€§ï¼š

  * **Lock** â†’ ä¸èƒ½æŠŠé”å†…çš„å†™æ“ä½œé‡æ’åˆ°å¤–é¢ã€‚
  * **Unlock** â†’ ä¸èƒ½æŠŠé”å†…çš„å†™æ“ä½œå»¶è¿Ÿåˆ°é”é‡Šæ”¾ä¹‹åã€‚
  * ç¡®ä¿ **happens-before** å…³ç³»ã€‚

---

| ç‰¹æ€§        | åº•å±‚ç»„æˆ                      | æ ¸å¿ƒæœºåˆ¶                      |
| --------- | ------------------------- | ------------------------- |
| Goroutine | Gç»“æ„ä½“ + æ ˆ + è°ƒåº¦ä¸Šä¸‹æ–‡          | M-P-G è°ƒåº¦ + gopark/goready |
| Mutex     | CAS + ä¿¡å·é‡                 | è‡ªæ—‹ + é˜»å¡/å”¤é†’                |
| Channel   | Lock + ç¯å½¢é˜Ÿåˆ— + send/recvé˜Ÿåˆ— | é˜»å¡/å”¤é†’ + æ•°æ®ä¼ é€’              |
| Once      | Mutex + åŸå­æ ‡è®°              | å†…å­˜å±éšœ + å¿«é€Ÿæ£€æŸ¥               |
| Timer     | MinHeap + M               | gopark/goready + å®šæ—¶å”¤é†’     |
| WaitGroup | Atomicè®¡æ•° + é˜»å¡é˜Ÿåˆ—           | gopark/goready            |


| Go åŸè¯­              | åº•å±‚æœºåˆ¶                       | é˜»å¡/å”¤é†’            |
| ------------------ | -------------------------- | ---------------- |
| Mutex              | CAS + è‡ªæ—‹ + ä¿¡å·é‡             | gopark / goready |
| RWMutex            | CAS + ä¿¡å·é‡ + è¯»å†™è®¡æ•°           | gopark / goready |
| Channel            | Lock + ç¯å½¢é˜Ÿåˆ— + send/recv é˜Ÿåˆ— | gopark / goready |
| Once               | Mutex + atomic + å†…å­˜å±éšœ      | gopark / goready |
| WaitGroup          | Atomic è®¡æ•° + é˜»å¡é˜Ÿåˆ—           | gopark / goready |
| Timer / Time.Sleep | MinHeap + M                | gopark / goready |


| ç‰¹æ€§    | Java AQS                                   | Go runtime                                   |
| ----- | ------------------------------------------ | -------------------------------------------- |
| state | int åŸå­è®¡æ•°                                   | atomic int / CAS                             |
| é˜»å¡é˜Ÿåˆ—  | CLH é˜Ÿåˆ—                                     | é˜»å¡ goroutine é“¾è¡¨ / channel queue              |
| é˜»å¡/å”¤é†’ | LockSupport.park/unpark                    | gopark / goready                             |
| é«˜çº§åŒæ­¥  | ReentrantLock / Semaphore / CountDownLatch | Mutex / RWMutex / Channel / WaitGroup / Once |
| æ¨¡æ¿æœºåˆ¶  | æä¾›ç»Ÿä¸€æ¨¡æ¿ï¼Œç”¨æˆ·ç»§æ‰¿                                | æ²¡æœ‰ç»Ÿä¸€æ¨¡æ¿ï¼Œä½† runtime æä¾›åŸè¯­ï¼Œç»„åˆå³å¯                   |


---

### 1. **Goroutine çš„çŠ¶æ€ï¼ˆG.statusï¼‰**

åœ¨ Go runtime ä¸­ï¼Œæ¯ä¸ª Goroutine éƒ½ç”¨ä¸€ä¸ª `G` ç»“æ„ä½“è¡¨ç¤ºï¼Œæ ¸å¿ƒå­—æ®µä¹‹ä¸€æ˜¯ `status`ï¼Œå¸¸è§çŠ¶æ€åŒ…æ‹¬ï¼š

| çŠ¶æ€          | æè¿°                              |
| ----------- | ------------------------------- |
| `Gidle`     | ç©ºé—²ï¼Œä¸åœ¨ä»»ä½•é˜Ÿåˆ—ä¸­                      |
| `Grunnable` | å¯è¿è¡Œï¼Œæ’åœ¨ P çš„ runqueue ä¸­ï¼Œç­‰å¾… M è°ƒåº¦   |
| `Grunning`  | æ­£åœ¨è¿è¡Œï¼ˆè¢« M æ‰§è¡Œï¼‰                    |
| `Gwaiting`  | é˜»å¡ç­‰å¾…æŸä¸ªäº‹ä»¶ï¼ˆchannelã€Mutexã€Timer ç­‰ï¼‰ |
| `Gsyscall`  | æ­£åœ¨æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼ˆé˜»å¡åœ¨å†…æ ¸çº¿ç¨‹ï¼‰               |
| `Gdead`     | æ‰§è¡Œå®Œæˆæˆ–è¢«å›æ”¶                        |

---

### 2. **çŠ¶æ€æ‰­è½¬ï¼ˆState Transitionsï¼‰**

Goroutine çš„çŠ¶æ€ä¼šæ ¹æ®è°ƒåº¦å’ŒåŒæ­¥åŸè¯­ä¸æ–­åˆ‡æ¢ï¼Œä¸»è¦æµç¨‹ï¼š

#### ï¼ˆ1ï¼‰åˆ›å»º

```go
go f()
```

* runtime åˆ†é… Gï¼Œåˆå§‹çŠ¶æ€ï¼š

  ```
  Gidle â†’ Grunnable
  ```
* æ”¾å…¥æŸä¸ª P çš„ local runqueue æˆ–å…¨å±€é˜Ÿåˆ—ã€‚

#### ï¼ˆ2ï¼‰è°ƒåº¦è¿è¡Œ

* è°ƒåº¦å™¨é€‰æ‹© G æ‰§è¡Œï¼š

  ```
  Grunnable â†’ Grunning
  ```
* å½“å‰ M æ‰§è¡Œè¯¥ G çš„ä»£ç ã€‚

#### ï¼ˆ3ï¼‰é˜»å¡ç­‰å¾…

* è°ƒç”¨åŒæ­¥åŸè¯­ï¼ˆMutexã€Channelã€WaitGroupã€Timer ç­‰ï¼‰é˜»å¡ï¼š

  ```
  Grunning â†’ Gwaiting
  ```
* åº•å±‚é€šè¿‡ `gopark()` å®ç°ï¼ŒG è¢«æŒ‚èµ·ï¼Œç­‰å¾…äº‹ä»¶ã€‚

#### ï¼ˆ4ï¼‰å”¤é†’å¯è¿è¡Œ

* æ¡ä»¶æ»¡è¶³ï¼ˆUnlock / send / receive / Done / Timer åˆ°æœŸï¼‰ï¼š

  ```
  Gwaiting â†’ Grunnable
  ```
* æ”¾å› P çš„ runqueueï¼Œç­‰å¾… M è°ƒåº¦æ‰§è¡Œã€‚

#### ï¼ˆ5ï¼‰æ‰§è¡Œå®Œæˆ

* Goroutine æ‰§è¡Œå®Œå‡½æ•°ï¼š

  ```
  Grunning â†’ Gdead
  ```
* runtime å¯ä»¥å›æ”¶æ ˆå’Œ G ç»“æ„ä½“ã€‚

---

### 3. **çŠ¶æ€æ‰­è½¬å›¾ï¼ˆç®€åŒ–ç‰ˆï¼‰**

```
Gidle â†’ Grunnable â†’ Grunning â†’ Gwaiting â†’ Grunnable â†’ Grunning â†’ Gdead
                     â†˜--------------------â†—
```

* **å¾ªç¯éƒ¨åˆ†**ï¼šé˜»å¡/å”¤é†’å¤šæ¬¡ã€‚
* **ä¸€æ¬¡æ€§ç»ˆæ­¢**ï¼šæ‰§è¡Œå®Œæˆè¿›å…¥ Gdeadã€‚

---

### 4. **çŠ¶æ€æ‰­è½¬ä¸åŒæ­¥åŸè¯­çš„å…³ç³»**

| åŒæ­¥åŸè¯­            | çŠ¶æ€å˜åŒ–                            |
| --------------- | ------------------------------- |
| Mutex / RWMutex | Grunning â†’ Gwaiting â†’ Grunnable |
| Channel         | Grunning â†’ Gwaiting â†’ Grunnable |
| WaitGroup       | Grunning â†’ Gwaiting â†’ Grunnable |
| Timer / Sleep   | Grunning â†’ Gwaiting â†’ Grunnable |

ğŸ’¡ æ ¸å¿ƒæ€æƒ³ï¼š**é˜»å¡ä¸æ¶ˆè€—çº¿ç¨‹ï¼Œå”¤é†’ç”±è°ƒåº¦å™¨ç®¡ç†**ï¼Œè½»é‡é«˜æ•ˆã€‚

---

